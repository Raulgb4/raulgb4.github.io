---
const {
  to = 100,
  duration = 900,
  suffix = "",
  prefix = "",
  decimals = 0,
} = Astro.props;

const id = `countup-${Math.random().toString(36).slice(2)}`;
---

<!--
  CountUp.astro
-------------
Lightweight number counter component that animates from 0 to a target value
using a smooth easing function. The animation starts only when the element
enters the viewport, improving performance and avoiding unnecessary work.
Fully configurable via props (duration, decimals, prefix, suffix).
-->
<span id={id} class="tabular-nums">{prefix}{0}{suffix}</span>

<script define:vars={{ id, to, duration, suffix, prefix, decimals }}>
  const el = document.getElementById(id);

  const animate = () => {
    const start = performance.now();
    const from = 0;

    const tick = (now) => {
      const t = Math.min(1, (now - start) / duration);
      // easeOutCubic
      const eased = 1 - Math.pow(1 - t, 3);

      const value = from + (to - from) * eased;
      el.textContent = prefix + value.toFixed(decimals) + suffix;

      if (t < 1) requestAnimationFrame(tick);
    };

    requestAnimationFrame(tick);
  };

  const obs = new IntersectionObserver(
    ([entry]) => {
      if (entry.isIntersecting) {
        animate();
        obs.disconnect();
      }
    },
    { threshold: 0.35 },
  );

  obs.observe(el);
</script>
