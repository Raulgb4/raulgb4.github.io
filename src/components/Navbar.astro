---
const currentPath = Astro.url.pathname;

import { t, type Lang } from "../i18n";

const { lang = "en" } = Astro.props as { lang?: Lang };

const isActive = (path: string) => currentPath === path;

const linkClass = (path: string) =>
  `group relative inline-block transition-colors duration-200 ${
    isActive(path)
      ? "text-emerald-600 dark:text-emerald-400 font-semibold"
      : "text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400"
  }`;
---

<!--
  Navbar.astro
  ------------
  Global navigation bar component that provides primary site navigation,
  language switching, and responsive behavior for desktop and mobile views.
  It highlights the active section based on the current route, adapts links
  to the selected language, and includes an accessible mobile menu with
  client-side toggling logic.
--><!-- Mobile dropdown -->
<div
  id="mobile-nav"
  class="lg:hidden hidden mt-3 rounded-2xl border border-gray-200/70 dark:border-white/10
         bg-white/80 dark:bg-slate-900/40 backdrop-blur p-3
         shadow-lg shadow-emerald-500/10"
  data-mobile-menu
>
  <nav class="flex flex-col gap-1 text-base">
    <a
      href={`/${lang}/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.home")}
    </a>

    <a
      href={`/${lang}/about/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.about")}
    </a>

    <a
      href={`/${lang}/help/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.help")}
    </a>

    <a
      href={`/${lang}/experience/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.experience")}
    </a>

    <a
      href={`/${lang}/certifications/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.certifications")}
    </a>

    <a
      href={`/${lang}/faq/`}
      class="rounded-xl px-3 py-2 text-gray-800 dark:text-gray-200 hover:bg-emerald-500/10"
    >
      {t(lang, "nav.faq")}
    </a>

    <a
      href={`/${lang}/contact/`}
      class="mt-2 inline-flex items-center justify-center rounded-xl px-4 py-2 font-semibold
           bg-emerald-500 text-white hover:bg-emerald-600 transition"
    >
      {t(lang, "nav.contact")}
      <span
        class="ml-2 inline-block h-2 w-2 rounded-full bg-white/90"
        aria-hidden="true"></span>
    </a>
  </nav>
</div>

<nav
  class="relative z-50 isolate w-full border-b border-gray-200 dark:border-gray-700"
>
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <!-- Left: Name + Mini Avatar -->
    <div class="flex items-center gap-3 font-semibold">
      <!-- Mini avatar -->
      <div class="relative group">
        <!-- Glow -->
        <div
          class="pointer-events-none absolute inset-0 rounded-full
                 bg-linear-to-br from-emerald-500 via-teal-400 to-cyan-400
                 blur-lg opacity-50
                 transition-opacity duration-500
                 group-hover:opacity-90"
          aria-hidden="true"
        >
        </div>

        <!-- Frame -->
        <div
          class="relative w-10 h-10 md:w-12 md:h-12 rounded-full
                 bg-linear-to-br from-emerald-400 via-teal-400 to-green-500
                 p-0.5"
        >
          <!-- Image -->
          <div
            class="w-full h-full rounded-full bg-gray-900 overflow-hidden
                   border border-white/10"
          >
            <img
              src="/assets/images/PerfilDibujo.png"
              class="w-full h-full object-cover
                     transition-transform duration-500
                     group-hover:scale-105"
              loading="eager"
              alt=""
            />
          </div>
        </div>
      </div>

      <!-- Name -->
      <a href={`/${lang}/`} class="group">
        <span
          class="text-xl md:text-2xl
           bg-linear-to-r from-emerald-400 via-teal-400 to-green-500
           dark:from-emerald-300 dark:via-teal-300 dark:to-green-400
           bg-clip-text text-transparent
           tracking-tight
           transition-opacity duration-200
           group-hover:opacity-90"
        >
          Raulgb
        </span>
      </a>
    </div>

    <!-- Center: Navigation links -->
    <ul class="hidden lg:flex items-center gap-6 text-lg">
      <li>
        <a href={`/${lang}/`} class={linkClass(`/${lang}/`)}>
          {t(lang, "nav.home")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/`) ? "scale-x-100" : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a href={`/${lang}/about/`} class={linkClass(`/${lang}/about/`)}>
          {t(lang, "nav.about")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/about/`)
                ? "scale-x-100"
                : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a href={`/${lang}/help/`} class={linkClass(`/${lang}/help/`)}>
          {t(lang, "nav.help")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/help/`)
                ? "scale-x-100"
                : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a
          href={`/${lang}/experience/`}
          class={linkClass(`/${lang}/experience/`)}
        >
          {t(lang, "nav.experience")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/experience/`)
                ? "scale-x-100"
                : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a
          href={`/${lang}/certifications/`}
          class={linkClass(`/${lang}/certifications/`)}
        >
          {t(lang, "nav.certifications")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/certifications/`)
                ? "scale-x-100"
                : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a href={`/${lang}/faq/`} class={linkClass(`/${lang}/faq/`)}>
          {t(lang, "nav.faq")}
          <span
            class={`absolute left-0 -bottom-1 h-0.5 w-full origin-left scale-x-0 bg-emerald-600 dark:bg-emerald-400 transition-transform duration-200 ${
              isActive(`/${lang}/faq/`)
                ? "scale-x-100"
                : "group-hover:scale-x-100"
            }`}></span>
        </a>
      </li>

      <li>
        <a
          href={`/${lang}/contact/`}
          aria-current={isActive(`/${lang}/contact/`) ? "page" : undefined}
          class={`relative inline-flex items-center justify-center rounded-full px-5 py-2 font-semibold
        transition-all duration-300
        ${
          isActive(`/${lang}/contact/`)
            ? "bg-emerald-500 text-white shadow-lg shadow-emerald-500/25"
            : "bg-emerald-500/10 text-emerald-600 ring-1 ring-emerald-500/30 hover:bg-emerald-500/15 hover:text-emerald-700 hover:ring-emerald-500/50"
        }
        dark:${
          isActive(`/${lang}/contact/`)
            ? "bg-emerald-400 text-slate-950 shadow-lg shadow-emerald-400/20"
            : "bg-emerald-400/10 text-emerald-300 ring-1 ring-emerald-400/30 hover:bg-emerald-400/15 hover:text-emerald-200 hover:ring-emerald-400/50"
        }
        hover:-translate-y-0.5 hover:shadow-xl`}
        >
          {t(lang, "nav.contact")}

          {
            !isActive(`/${lang}/contact/`) && (
              <span
                class="ml-2 inline-block h-2 w-2 rounded-full bg-emerald-400/80
                 shadow-[0_0_12px_rgba(52,211,153,0.65)]"
                aria-hidden="true"
              />
            )
          }
        </a>
      </li>
    </ul>

    <!-- Right: Actions -->
    <div
      class="flex items-center gap-4 text-base text-gray-700 dark:text-gray-300"
    >
      <!-- Language switcher (pill with flags) -->
      <div
        id="lang-switcher-pill"
        class="flex items-center rounded-full
         border border-gray-200 dark:border-white/10
         bg-white/70 dark:bg-white/5 backdrop-blur
         p-1"
      >
        <!-- EN -->
        <a
          href="/en/"
          data-lang="en"
          aria-label="Switch to English"
          class={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold transition
      ${
        lang === "en"
          ? "bg-emerald-500/15 text-emerald-700 dark:text-emerald-300"
          : "text-gray-600 dark:text-gray-300 hover:bg-gray-200/40 dark:hover:bg-white/10"
      }`}
        >
          <span class="h-4 w-4 rounded-sm overflow-hidden shrink-0">
            <img
              src="/assets/flags/UKFlag.svg"
              alt=""
              class="h-full w-full object-cover"
              loading="eager"
              aria-hidden="true"
            />
          </span>
          <span>EN</span>
        </a>

        <!-- ES -->
        <a
          href="/es/"
          data-lang="es"
          aria-label="Cambiar a Español"
          class={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold transition
      ${
        lang === "es"
          ? "bg-emerald-500/15 text-emerald-700 dark:text-emerald-300"
          : "text-gray-600 dark:text-gray-300 hover:bg-gray-200/40 dark:hover:bg-white/10"
      }`}
        >
          <img
            src="/assets/flags/SpainFlag.svg"
            alt="Español"
            class="h-4 w-4 rounded-sm overflow-hidden"
            loading="eager"
            aria-hidden="true"
          />
          <span>ES</span>
        </a>
      </div>

      <script>
        type Lang = "en" | "es";

        // Mantiene: path + query + hash (sección)
        function buildLangUrl(newLang: Lang): string {
          const { pathname, search, hash } = window.location;

          // Quita el prefijo /en o /es si existe
          const pathWithoutLang = pathname.replace(/^\/(en|es)(?=\/|$)/, "");

          // Evita doble slash
          const normalized = pathWithoutLang.startsWith("/")
            ? pathWithoutLang
            : `/${pathWithoutLang}`;

          return `/${newLang}${normalized}${search}${hash}`;
        }

        const pill = document.getElementById("lang-switcher-pill");

        pill?.addEventListener("click", (e: MouseEvent) => {
          // EventTarget no tiene closest(), por eso convertimos a Element
          const target = e.target;
          if (!(target instanceof Element)) return;

          const a = target.closest<HTMLAnchorElement>("a[data-lang]");
          if (!a) return;

          e.preventDefault();

          const newLang = a.getAttribute("data-lang") as Lang | null;
          if (!newLang) return;

          window.location.href = buildLangUrl(newLang);
        });
      </script>
    </div>

    <!-- Mobile menu button -->
    <button
      type="button"
      class="lg:hidden inline-flex items-center justify-center rounded-xl
         border border-emerald-500/25 bg-emerald-500/10
         px-3 py-2 text-emerald-600 dark:text-emerald-300
         hover:bg-emerald-500/15 hover:border-emerald-500/40
         transition"
      aria-label="Open menu"
      aria-controls="mobile-nav"
      aria-expanded="false"
      data-mobile-menu-button
    >
      <!-- icon -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        class="h-5 w-5"
      >
        <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>
</nav>

<script is:inline>
  const btn = document.querySelector("[data-mobile-menu-button]");
  const menu = document.querySelector("[data-mobile-menu]");

  if (btn && menu) {
    const setOpen = (open) => {
      menu.classList.toggle("hidden", !open);
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    };

    btn.addEventListener("click", () => {
      const isOpen = btn.getAttribute("aria-expanded") === "true";
      setOpen(!isOpen);
    });

    // Close on outside click
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && !btn.contains(e.target)) setOpen(false);
    });

    // Close on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });

    // Close after clicking a link
    menu
      .querySelectorAll("a")
      .forEach((a) => a.addEventListener("click", () => setOpen(false)));
  }
</script>
