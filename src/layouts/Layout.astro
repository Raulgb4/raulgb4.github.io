---
import "../styles/global.css";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import BackToTop from "../components/BackToTop.astro";

type SeoData = { title: string; description: string };
type PageSeo = { en?: SeoData; es?: SeoData };

const { lang = "en", pageSeo } = Astro.props as {
  lang?: "en" | "es";
  pageSeo?: PageSeo;
};

const seo = {
  en: {
    title: "Raúl García Balongo | Computer Science Engineer",
    description:
      "Computer Science Engineer focused on data analysis, business intelligence, and web development.",
    ogLocale: "en_US",
  },
  es: {
    title: "Raúl García Balongo | Ingeniero Informático",
    description:
      "Ingeniero Informático enfocado en análisis de datos, business intelligence y desarrollo web.",
    ogLocale: "es_ES",
  },
};

const site = {
  name: "Raúl García Balongo",
  baseUrl: "https://raulgb4.github.io/curriculum-vitae",
  ogImage: "https://raulgb4.github.io/curriculum-vitae/og/og-image.png",
};

const resolvedTitle = pageSeo?.[lang]?.title ?? seo[lang].title;
const resolvedDescription =
  pageSeo?.[lang]?.description ?? seo[lang].description;

const pathname = Astro.url.pathname;

const canonicalUrl = `${site.baseUrl}${pathname}`;

const altPathEn = pathname.replace(/^\/(es|en)/, "/en");
const altPathEs = pathname.replace(/^\/(es|en)/, "/es");
const hrefEn = `${site.baseUrl}${altPathEn}`;
const hrefEs = `${site.baseUrl}${altPathEs}`;

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: "Raúl García Balongo",
  jobTitle:
    lang === "es" ? "Ingeniero Informático" : "Computer Science Engineer",
  description: seo[lang].description,
  url: `${site.baseUrl}/${lang}/`,
  sameAs: [
    "https://www.linkedin.com/in/ra%C3%BAl-garc%C3%ADa-balongo-865948350/",
    "https://github.com/Raulgb4",
  ],
};

const personSchemaJson = JSON.stringify(personSchema);
---

<!--
  Layout.astro
  ------------
  Global layout component that defines the base HTML structure of the site.
  It centralizes SEO metadata, internationalization-aware URLs, Open Graph
  and Twitter tags, structured data (Person schema), analytics integration,
  and shared UI elements such as the navbar, footer, and back-to-top button.
  All pages are rendered within this layout to ensure consistency.
--><!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{resolvedTitle}</title>
    <meta name="description" content={resolvedDescription} />

    <link rel="canonical" href={canonicalUrl} />

    <link rel="alternate" hreflang="en" href={hrefEn} />
    <link rel="alternate" hreflang="es" href={hrefEs} />
    <link rel="alternate" hreflang="x-default" href={`${site.baseUrl}/en/`} />

    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="/assets/images/PerfilDibujo.png" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={site.name} />
    <meta property="og:title" content={resolvedTitle} />
    <meta property="og:description" content={resolvedDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta
      property="og:image"
      content={`${site.baseUrl}/assets/images/PerfilDibujo.png`}
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content={seo[lang].ogLocale} />
    <meta
      property="og:locale:alternate"
      content={lang === "es" ? "en_US" : "es_ES"}
    />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={resolvedTitle} />
    <meta name="twitter:description" content={resolvedDescription} />
    <meta
      name="twitter:image"
      content={`${site.baseUrl}/assets/images/PerfilDibujo.png`}
    />

    <!-- Structured data -->
    <script type="application/ld+json" set:html={personSchemaJson} />

    <!-- Umami Analytics (privacy-friendly) -->
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="33fa057c-ec5f-42e1-9fb1-9099fa7802b5"></script>
  </head>

  <body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white">
    <Navbar lang={lang} />
    <main><slot /></main>
    <Footer lang={lang} />
    <BackToTop />

    <script is:inline>
      const els = document.querySelectorAll("[data-reveal]");
      const io = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (!entry.isIntersecting) continue;
            const el = entry.target;
            const delay = Number(el.getAttribute("data-delay") || "0");
            el.style.setProperty("--reveal-delay", `${delay}ms`);
            el.classList.add("is-visible");
            const once = el.getAttribute("data-once") === "true";
            if (once) io.unobserve(el);
          }
        },
        { threshold: 0.08, rootMargin: "0px 0px -15% 0px" },
      );
      els.forEach((el) => io.observe(el));
    </script>
  </body>
</html>
